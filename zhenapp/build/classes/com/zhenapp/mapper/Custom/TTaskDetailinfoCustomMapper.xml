<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.zhenapp.mapper.Custom.TTaskDetailinfoCustomMapper" >
  <select id="requesttaskByphoneid" parameterType="java.util.HashMap" resultType="com.zhenapp.po.Custom.TTaskDetailInfoCustom">
  	SELECT a.* FROM t_task_detailinfo_temp a where a.phoneid=#{phoneid} AND a.taskstate='40' ORDER BY taskhour,taskminute LIMIT 0,1
  </select>
    <select id="requesttaskByphoneid_temp" parameterType="java.util.HashMap" resultType="com.zhenapp.po.Custom.TTaskDetailInfoCustom">
  	SELECT a.* FROM t_task_detailinfo a
	<where>
		<if test="iscollection != null and iscollection != '' ">
			AND a.iscollection ='1'
		</if>
		<if test="isshopping != null and isshopping != '' ">
			AND a.isshopping ='1'
		</if>
		<if test="tasknumstr != null and tasknumstr != '' ">
			AND a.taskkeynum NOT IN (#{tasknumstr})
		</if>
	</where>
	AND a.phoneid IS NULL AND a.taskstate='40' AND a.taskdate=#{today} and a.resultstr is null
	AND (CASE WHEN a.taskminute>9 THEN CONCAT(a.taskhour,a.taskminute)+0 <![CDATA[<=]]> #{HHmm}+0 ELSE CONCAT(a.taskhour,'0',a.taskminute)+0 <![CDATA[<=]]> #{HHmm}+0 END)
  	ORDER BY a.taskhour,a.taskminute LIMIT 0,1
  </select>
   
  <select id="findtaskdatacount" parameterType="java.util.HashMap" resultType="com.zhenapp.po.Custom.TTaskDetailInfoCustom">
  		SELECT phoneid,SUM(isshopping) AS shoppingcount,SUM(iscollection) AS collectioncount FROM t_task_detailinfo WHERE taskdate =#{date} AND taskstate='21' GROUP BY phoneid
  </select>
  <select id="findtaskdatasum" parameterType="java.util.HashMap" resultType="com.zhenapp.po.Custom.TTaskDetailInfoCustom">
  		SELECT SUM(isshopping) AS shoppingcount,SUM(iscollection) AS collectioncount FROM t_task_detailinfo WHERE taskdate =#{date} AND taskstate='21' 
  </select>
  
  <select id="findCounts" resultType="int" parameterType="java.util.HashMap">
  	select count(1) from t_task_detailinfo 
  	<where>
  		<if test="taskid != null and taskid != '' ">
  			and taskid = #{taskid}
  		</if>
  		<if test="taskstate != null and taskstate != '' ">
  			and taskstate in (${taskstate})
  		</if>
  	</where>
  </select>
  <select id="findcollectioncount" resultType="int" parameterType="java.util.HashMap">
  	select count(1) from t_task_detailinfo
  	<where>
  		<if test="taskid != null and taskid != '' ">
  			and taskid = #{taskid}
  		</if>
  		<if test="taskstate != null and taskstate != '' ">
  			and taskstate in (${taskstate})
  		</if>
  		and iscollection = '1' and isshopping = '0'
  	</where>
  </select>
  <select id="findshoppingcount" resultType="int" parameterType="java.util.HashMap">
  	select count(1) from t_task_detailinfo
  	<where>
  		<if test="taskid != null and taskid != '' ">
  			and taskid = #{taskid}
  		</if>
  		<if test="taskstate != null and taskstate != '' ">
  			and taskstate in (${taskstate})
  		</if>
  		and iscollection = '0' and isshopping = '1'
  	</where>
  </select>
  
  <select id="findTaskDetailByProblemAndPage" resultType="com.zhenapp.po.Custom.TTaskDetailInfoCustom"  parameterType="java.util.HashMap">
  		select * from t_task_detailinfo 
  		<where>
  			and phoneid IS NOT NULL AND visit IS NULL AND collect IS NULL AND trolley IS NULL AND TIMESTAMPDIFF(MINUTE ,DATE_FORMAT(createtime,'%Y%m%d%H%i%s'),DATE_FORMAT(NOW(),'%Y%m%d%H%i%s'))>5
  			<if test="phoneid !=null and phoneid != ''">
		  		and phoneid = #{phoneid}
		  	</if>
	  		<if test="taskdetailpk !=null and taskdetailpk != ''">
		  		and taskdetailpk = #{taskdetailpk}
		  	</if>
		  	<if test="taskkeynum !=null and taskkeynum != ''">
		  		and taskkeynum = #{taskkeynum}
		  	</if>
  		</where>
  </select>
  
  
  <select id="findTotalTaskDetailByProblemAndPage" resultType="int" parameterType="java.util.HashMap">
  		select count(1) from t_task_detailinfo 
  		<where>
  			and phoneid IS NOT NULL AND visit IS NULL AND collect IS NULL AND trolley IS NULL AND TIMESTAMPDIFF(MINUTE ,DATE_FORMAT(createtime,'%Y%m%d%H%i%s'),DATE_FORMAT(NOW(),'%Y%m%d%H%i%s'))>5
  			<if test="phoneid !=null and phoneid != ''">
		  		and phoneid = #{phoneid}
		  	</if>
	  		<if test="taskdetailpk !=null and taskdetailpk != ''">
		  		and taskdetailpk = #{taskdetailpk}
		  	</if>
		  	<if test="taskkeynum !=null and taskkeynum != ''">
		  		and taskkeynum = #{taskkeynum}
		  	</if>
  		</where>
  </select>
  
  <select id="findTaskDetailByPage" resultType="com.zhenapp.po.Custom.TTaskDetailInfoCustom" parameterType="java.util.HashMap">
	SELECT g.dicinfoname as taskstatename,f.taskpk,a.taskdetailpk, a.taskdetailid, a.taskid, a.taskkeyword, a.searchtype,e.dicinfoname AS tasktypename, a.price, a.region, a.isfreeship, 
    a.istmall, a.iscollection,CASE WHEN a.iscollection='0' THEN '否' ELSE '是' END AS iscollectionname,a.isshopping, CASE WHEN a.isshopping='0' THEN '否' ELSE '是' END AS isshoppingname, a.taskkeynum, a.minpicture, a.maxpicture, a.tasktype, 
    a.isflow, a.iscreativetitle, a.isshopcollect, a.taskstate, a.taskdate, a.taskhour, a.taskminute, 
    a.visit,b.dictypename AS visitname ,a.collect,c.dictypename AS collectname, a.trolley, d.dictypename AS trolleyname, a.phoneid, a.subtractpoints, a.resultstr,DATE_FORMAT(a.createtime,'%Y-%m-%d %H:%i:%s') AS createtime, a.createuser, DATE_FORMAT(a.updatetime,'%Y-%m-%d %H:%i:%s') AS updatetime, 
    a.updateuser FROM t_task_detailinfo a
	LEFT JOIN t_data_dic_info b ON a.visit=b.dicinfoid
	LEFT JOIN t_data_dic_info c ON a.collect=c.dicinfoid
	LEFT JOIN t_data_dic_info d ON a.trolley=d.dicinfoid
	LEFT JOIN t_data_dic_info e ON a.tasktype=e.dicinfoid
	LEFT JOIN t_data_dic_info g ON a.taskstate=g.dicinfoid
	LEFT JOIN t_task_info f on a.taskid = f.taskid
	  <where>
	  	<if test="today != null and today != '' ">
			and a.taskdate+0 <![CDATA[>=]]> #{today}
		</if>
		<if test="before != null and before != '' ">
			and a.taskdate+0 <![CDATA[<]]> #{before}
		</if>
	  	<if test="taskid !=null and taskid != ''">
	  		and a.taskid = #{taskid}
	  	</if>
	  	<if test="taskpk !=null and taskpk != ''">
	  		and f.taskpk = #{taskpk}
	  	</if>
	  	<if test="detaid !=null and detaid != ''">
	  		and a.taskdetailid = #{detaid}
	  	</if>
	  	<if test="taskdetailpk !=null and taskdetailpk != ''">
	  		and a.taskdetailpk = #{taskdetailpk}
	  	</if>
	  	<if test="taskkeynum !=null and taskkeynum != ''">
	  		and a.taskkeynum = #{taskkeynum}
	  	</if>
	  	<if test="phoneid !=null and phoneid != ''">
	  		and a.phoneid = #{phoneid}
	  	</if>
	  	<if test="taskhour !=null and taskhour != ''">
	  		and a.taskhour = #{taskhour}
	  	</if>
	  	<if test="tasktype !=null and tasktype != ''">
	  		and a.tasktype = #{tasktype}
	  	</if>
	  </where>
	  order by a.phoneid desc limit #{page},#{rows}
  </select>
    <select id="findTaskDetailTotalByPage" resultType="int" parameterType="java.util.HashMap">
	  SELECT count(1) FROM t_task_detailinfo a
	  <where>
	  	<if test="today != null and today != '' ">
			and a.taskdate+0 <![CDATA[>=]]> #{today}
		</if>
		<if test="before != null and before != '' ">
			and a.taskdate+0 <![CDATA[<]]> #{before}
		</if>
	  	<if test="taskid !=null and taskid != ''">
	  		and a.taskid = #{taskid}
	  	</if>
	  	<if test="taskdetailpk !=null and taskdetailpk != ''">
	  		and a.taskdetailpk = #{taskdetailpk}
	  	</if>
	  	<if test="taskkeynum !=null and taskkeynum != ''">
	  		and a.taskkeynum = #{taskkeynum}
	  	</if>
	  	<if test="phoneid !=null and phoneid != ''">
	  		and a.phoneid = #{phoneid}
	  	</if>
	  	<if test="taskhour !=null and taskhour != ''">
	  		and a.taskhour = #{taskhour}
	  	</if>
	  	<if test="tasktype !=null and tasktype != ''">
	  		and a.tasktype = #{tasktype}
	  	</if>
	  </where>
  </select>
  <select id="findTaskDetailByIdAndtask" parameterType="java.util.HashMap" resultType="int">
  	SELECT COUNT(1) FROM t_task_detailinfo
  	<where>
  		<if test="taskdate != null and taskdate != '' ">
  			and taskdate = #{taskdate}
  		</if>
  		<if test="taskkeynum != null and taskkeynum != '' ">
  			and taskkeynum = #{taskkeynum}
  		</if>
  		<if test="iscollection != null and iscollection != '' ">
  			and iscollection = #{iscollection}
  		</if>
  		<if test="isshopping != null and isshopping != '' ">
  			and isshopping = #{isshopping}
  		</if>
  		<if test="taskstate != null and taskstate != '' ">
  			and taskstate in (${taskstate})
  		</if>
  	</where>
  </select>
  
  <insert id="insertDetailinfo" parameterType="com.zhenapp.po.Custom.TTaskDetailInfoCustom" >
     insert into t_task_detailinfo (taskdetailid, taskid, 
      taskkeyword, searchtype, price, 
      region, isfreeship, istmall, 
      iscollection, isshopping, taskkeynum, 
      minpicture, maxpicture, tasktype, 
      isflow, iscreativetitle, isshopcollect, 
      taskstate, taskdate, taskhour, 
      taskminute, visit, collect, 
      trolley, phoneid, subtractpoints, 
      createtime, createuser, updatetime, 
      updateuser)
    values ( #{taskdetailid,jdbcType=VARCHAR}, #{taskid,jdbcType=VARCHAR}, 
      #{taskkeyword,jdbcType=VARCHAR}, #{searchtype,jdbcType=VARCHAR}, #{price,jdbcType=VARCHAR}, 
      #{region,jdbcType=VARCHAR}, #{isfreeship,jdbcType=VARCHAR}, #{istmall,jdbcType=VARCHAR}, 
      #{iscollection,jdbcType=VARCHAR}, #{isshopping,jdbcType=VARCHAR}, #{taskkeynum,jdbcType=VARCHAR}, 
      #{minpicture,jdbcType=VARCHAR}, #{maxpicture,jdbcType=VARCHAR}, #{tasktype,jdbcType=VARCHAR}, 
      #{isflow,jdbcType=VARCHAR}, #{iscreativetitle,jdbcType=VARCHAR}, #{isshopcollect,jdbcType=VARCHAR}, 
      #{taskstate,jdbcType=VARCHAR}, #{taskdate,jdbcType=VARCHAR}, #{taskhour,jdbcType=VARCHAR}, 
      #{taskminute,jdbcType=VARCHAR}, #{visit,jdbcType=VARCHAR}, #{collect,jdbcType=VARCHAR}, 
      #{trolley,jdbcType=VARCHAR}, #{phoneid,jdbcType=VARCHAR}, #{subtractpoints,jdbcType=INTEGER}, 
      #{createtime,jdbcType=VARCHAR}, #{createuser,jdbcType=VARCHAR}, #{updatetime,jdbcType=VARCHAR}, 
      #{updateuser,jdbcType=VARCHAR})
  </insert>

  <update id="updateTaskDetailstate" parameterType="java.util.HashMap">
  	update t_task_detailinfo set taskstate = #{taskstate},phoneid = #{phoneid}  where taskdetailid = #{taskdetailid} and phoneid is null
  </update>
  
  <update id="updateTaskDetailstateByTaskidAndoldstate" parameterType="java.util.HashMap">
  	update t_task_detailinfo set taskstate = #{newstate},updatetime=#{updatetime},updateuser=#{updateuser} where taskid = #{taskid}  and taskstate in (${oldstate})
  </update>
  
  <update id="updateterminationstate" parameterType="java.util.HashMap">
  	update t_task_detailinfo set taskstate = '23'  where taskid = #{taskid} and phoneid is null and taskstate = '40'
  </update>
  
  <select id="findPointsByteterminationstate" parameterType="String" resultType="int">
  	select IFNULL(sum(subtractpoints),0) from t_task_detailinfo where taskid = #{taskid} and taskstate = '23'
  </select>
 
  <select id="findcountEndstate" parameterType="String" resultType="int">
  	select count(1) from t_task_detailinfo where taskid = #{taskid} and taskstate = '23'
  </select>
  
  <select id="findTaskDetailInfoByIdAndTaskstate" parameterType="java.util.HashMap" resultType="int">
  	select count(1) from t_task_detailinfo 
  	<where>
  		<if test="taskstate !=null and taskstate != '' ">
  			and taskstate = #{taskstate}
  		</if>
  		<if test="taskid !=null and taskid != '' ">
  			and taskid = #{taskid}
  		</if>
  		<if test="today !=null and today != '' ">
  			and taskdate = #{today}
  		</if>
  	</where>
  </select>
  
  <select id="findTaskDetailBypk" parameterType="String" resultType="com.zhenapp.po.Custom.TTaskDetailInfoCustom">
  	select * from t_task_detailinfo where taskdetailpk=#{taskdetailpk}
  </select>
  
  <select id="findTaskDetailByPidAndState" parameterType="java.util.HashMap" resultType="com.zhenapp.po.Custom.TTaskDetailInfoCustom">
  	select * from t_task_detailinfo 
  	<where>
  		<if test="phoneid != null and phoneid != '' ">
  			and phoneid = #{phoneid}
  		</if>
  		<if test="taskstate != null and taskstate != '' ">
  			and taskstate = #{taskstate}
  		</if>
  	</where>
  </select>
  
  <update id="updateTaskDetailByPidAndState" parameterType="java.util.HashMap" >
  	UPDATE t_task_detailinfo SET visit = (SELECT dicinfoid FROM t_data_dic_info WHERE dictypecode = 'visit' AND dictypename=#{visit}),
  	collect = (SELECT dicinfoid FROM t_data_dic_info WHERE dictypecode = 'collect' AND dictypename=#{collect}),
  	trolley = (SELECT dicinfoid FROM t_data_dic_info WHERE dictypecode = 'trolley' AND dictypename=#{trolley}),
  	taskstate = #{taskstatenew},
  	isflow=#{isflow},
  	iscreativetitle=#{iscreativetitle},
  	isshopcollect=#{isshopcollect},
  	updatetime=#{updatetime},updateuser=#{updateuser}
	<where>
		<if test="phoneid != null and phoneid != '' ">
			and phoneid = #{phoneid}
		</if>
		<if test="taskstate != null and taskstate != '' ">
			and taskstate = #{taskstate}
		</if>
	</where>
  </update>
  
    <update id="updateTaskDetail" parameterType="java.util.HashMap" >
  	UPDATE t_task_detailinfo SET visit = (SELECT dicinfoid FROM t_data_dic_info WHERE dictypecode = 'visit' AND dictypename=#{visit}),
  	collect = (SELECT dicinfoid FROM t_data_dic_info WHERE dictypecode = 'collect' AND dictypename=#{collect}),
  	trolley = (SELECT dicinfoid FROM t_data_dic_info WHERE dictypecode = 'trolley' AND dictypename=#{trolley}),
  	taskstate = #{taskstatenew},
  	isflow=#{isflow},
  	iscreativetitle=#{iscreativetitle},
  	isshopcollect=#{isshopcollect},
  	updatetime=#{updatetime},updateuser=#{updateuser}
	<where>
		<if test="phoneid != null and phoneid != '' ">
			and phoneid = #{phoneid}
		</if>
		<if test="taskstate != null and taskstate != '' ">
			and taskstate = #{taskstate}
		</if>
		<if test="taskdetailpk != null and taskdetailpk != '' ">
			and taskdetailpk = #{taskdetailpk}
		</if>
	</where>
  </update>
  <update id="updateTaskDetailresultByid"  parameterType="java.util.HashMap" >
  	update t_task_detailinfo set resultstr=#{result},updatetime=#{updatetime},updateuser=#{updateuser} where taskdetailid = #{taskdetailid} and phoneid is null
  </update>
  <delete id="deleteTaskBystate" parameterType="java.util.HashMap">
	  delete from t_task_detailinfo 
	  <where>
	  	<if test="taskstate != null and taskstate != '' ">
	  		and taskstate = #{taskstate}
	  	</if>
	  	<if test="taskid != null and taskid != '' ">
	  		and taskid = #{taskid}
	  	</if>
	  </where>
  </delete>
</mapper>
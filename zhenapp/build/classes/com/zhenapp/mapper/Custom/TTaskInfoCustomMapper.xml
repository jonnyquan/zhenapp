<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.zhenapp.mapper.Custom.TTaskInfoCustomMapper" >
  
  
  <select id="findTaskBypage" resultType="com.zhenapp.po.Custom.TTaskInfoCustom" parameterType="java.util.HashMap" >
    SELECT a.*,b.dicinfoname,c.finishflowcount,c.finishcollectioncount,c.finishshoppingcount,d.errorcount FROM t_task_info a
	LEFT JOIN (select dicinfoid,dicinfoname from t_data_dic_info WHERE dictypecode='runstate') b ON a.taskstate=b.dicinfoid
	LEFT JOIN (SELECT taskid,COUNT(isflow) AS finishflowcount,COUNT(iscreativetitle) AS finishcollectioncount,COUNT(isshopcollect) AS finishshoppingcount FROM t_task_detailinfo where taskstate='21' GROUP BY taskid) c ON a.taskid=c.taskid
	LEFT JOIN (SELECT taskid,COUNT(isflow) AS errorcount FROM t_task_detailinfo WHERE taskstate='22' GROUP BY taskid) d ON a.taskid=d.taskid
	<where>
    	<if test="taskid !=null and taskid!=''">
    		and a.taskid like '%${taskid}%'
    	</if>
    	<if test="datefrom != null and datefrom != ''">
    		and a.createtime <![CDATA[>=]]> #{datefrom}
    	</if>
    	<if test="dateto != null and dateto != ''">
    		and a.createtime <![CDATA[<=]]> #{dateto}
    	</if>
    </where>
     ORDER BY a.createtime DESC LIMIT #{page},#{rows}
  </select>
  
  <select id="findTotalTaskBypage" resultType="int" parameterType="java.util.HashMap" >
    select count(1) from t_task_info
    <where>
    	<if test="taskid !=null and taskid!=''">
    		and taskid like '%${taskid}%'
    	</if>
    	<if test="datefrom != null and datefrom != ''">
    		and createtime <![CDATA[>=]]> #{datefrom}
    	</if>
    	<if test="dateto != null and dateto != ''">
    		and createtime <![CDATA[<=]]> #{dateto}
    	</if>
    </where>
  </select>
  
  <select id="findAllTaskBypage" resultType="com.zhenapp.po.Custom.TTaskInfoCustom" parameterType="java.util.HashMap" >
    select * from t_task_info
    <where>
    	<if test="taskid !=null and taskid!=''">
    		and taskid like '%${taskid}%'
    	</if>
    	<if test="datefrom != null and datefrom != ''">
    		and createtime <![CDATA[>=]]> #{datefrom}
    	</if>
    	<if test="dateto != null and dateto != ''">
    		and createtime <![CDATA[<=]]> #{dateto}
    	</if>
    </where>
  </select>
  
  <select id="findTaskallocation" resultType="com.zhenapp.po.Custom.TTaskInfoCustom" parameterType="java.util.HashMap" >
    select * from t_task_info
    <where>
    	<if test="taskstate !=null and taskstate !=''">
    		AND taskstate=#{taskstate} 
    	</if>
    	<if test="taskstartdate != null and taskstartdate != ''">
    		AND taskstartdate=#{taskstartdate}
    	</if>
    </where>
  </select>
  
  <select id="findIsFirst" resultType="com.zhenapp.po.Custom.TTaskInfoCustom" parameterType="String" >
    select * from t_task_info WHERE taskkeynum=#{taskkeynum}
  </select>
  
  
  <insert id="insertTaskByapi" parameterType="com.zhenapp.po.Custom.TTaskInfoCustom">
  	 insert into t_task_info (taskpk, taskid, taskType, 
      taskkeynum, taskkeyword, taskstartdate, 
      taskenddate, taskhourcounts, taskminprice, 
      taskmaxprice, tasksearchType, taskimgztc, 
      taskimgpt, flowcount, Collectioncount, 
      Shoppingcount, tasktmallapppct, taskgprspct, 
      taskPlus, taskduration, taskstate, 
      createtime, createuser, updatetime, 
      updateuser)
    values (#{taskpk,jdbcType=INTEGER}, #{taskid,jdbcType=VARCHAR}, #{tasktype,jdbcType=VARCHAR}, 
      #{taskkeynum,jdbcType=VARCHAR}, #{taskkeyword,jdbcType=VARCHAR}, #{taskstartdate,jdbcType=VARCHAR}, 
      #{taskenddate,jdbcType=VARCHAR}, #{taskhourcounts,jdbcType=VARCHAR}, #{taskminprice,jdbcType=VARCHAR}, 
      #{taskmaxprice,jdbcType=VARCHAR}, #{tasksearchtype,jdbcType=VARCHAR}, #{taskimgztc,jdbcType=VARCHAR}, 
      #{taskimgpt,jdbcType=VARCHAR}, #{flowcount,jdbcType=INTEGER}, #{collectioncount,jdbcType=INTEGER}, 
      #{shoppingcount,jdbcType=INTEGER}, #{tasktmallapppct,jdbcType=VARCHAR}, #{taskgprspct,jdbcType=VARCHAR}, 
      #{taskplus,jdbcType=VARCHAR}, #{taskduration,jdbcType=VARCHAR}, #{taskstate,jdbcType=VARCHAR}, 
      #{createtime,jdbcType=VARCHAR}, #{createuser,jdbcType=VARCHAR}, #{updatetime,jdbcType=VARCHAR}, 
      #{updateuser,jdbcType=VARCHAR})
   </insert>
  
  <insert id="insertTaskInfo" parameterType="com.zhenapp.po.Custom.TTaskInfoCustom" >
     insert into t_task_info (taskid, taskType, 
      taskkeynum, taskkeyword, taskstartdate, 
      taskenddate, taskhourcounts, taskminprice, 
      taskmaxprice, tasksearchType, taskimgztc, 
      taskimgpt, flowcount, Collectioncount, 
      Shoppingcount, tasktmallapppct, taskgprspct, 
      taskPlus, taskduration, taskstate, 
      createtime, createuser, updatetime, 
      updateuser)
    values (#{taskid,jdbcType=VARCHAR}, #{tasktype,jdbcType=VARCHAR}, 
      #{taskkeynum,jdbcType=VARCHAR}, #{taskkeyword,jdbcType=VARCHAR}, #{taskstartdate,jdbcType=VARCHAR}, 
      #{taskenddate,jdbcType=VARCHAR}, #{taskhourcounts,jdbcType=VARCHAR}, #{taskminprice,jdbcType=VARCHAR}, 
      #{taskmaxprice,jdbcType=VARCHAR}, #{tasksearchtype,jdbcType=VARCHAR}, #{taskimgztc,jdbcType=VARCHAR}, 
      #{taskimgpt,jdbcType=VARCHAR}, #{flowcount,jdbcType=INTEGER}, #{collectioncount,jdbcType=INTEGER}, 
      #{shoppingcount,jdbcType=INTEGER}, #{tasktmallapppct,jdbcType=VARCHAR}, #{taskgprspct,jdbcType=VARCHAR}, 
      #{taskplus,jdbcType=VARCHAR}, #{taskduration,jdbcType=VARCHAR}, #{taskstate,jdbcType=VARCHAR}, 
      #{createtime,jdbcType=VARCHAR}, #{createuser,jdbcType=VARCHAR}, #{updatetime,jdbcType=VARCHAR}, 
      #{updateuser,jdbcType=VARCHAR})
  </insert>
  
  <update id="updateTaskstate" parameterType="String">
  	update t_task_info set taskstate="16" where taskid=#{taskid}
  </update>
  
  <delete id="deleteTaskBypk" parameterType="String">
    delete from t_task_info
    where taskpk in (${value})
  </delete>
</mapper>
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.zhenapp.mapper.Custom.TTaskInfoCustomMapper" >
  
  
  <select id="findTaskBypage" resultType="com.zhenapp.po.Custom.TTaskInfoCustom" parameterType="java.util.HashMap" >
    SELECT a.*,b.dicinfoname,c.finishflowcount,c.finishcollectioncount,c.finishshoppingcount,d.errorcount,e.dicinfoname as tasktypename FROM t_task_info a
	LEFT JOIN (select dicinfoid,dicinfoname from t_data_dic_info WHERE dictypecode='runstate') b ON a.taskstate=b.dicinfoid
	left join t_data_dic_info e ON a.tasktype=e.dicinfoid
	LEFT JOIN (SELECT taskid,COUNT(isflow) AS finishflowcount,COUNT(iscreativetitle) AS finishcollectioncount,COUNT(isshopcollect) AS finishshoppingcount FROM t_task_detailinfo where taskstate='21' GROUP BY taskid) c ON a.taskid=c.taskid
	LEFT JOIN (SELECT taskid,COUNT(isflow) AS errorcount FROM t_task_detailinfo WHERE taskstate='22' GROUP BY taskid) d ON a.taskid=d.taskid
	<where>
    	<if test="taskid !=null and taskid!=''">
    		and a.taskid like '%${taskid}%'
    	</if>
    	<if test="datefrom != null and datefrom != ''">
    		and a.createtime <![CDATA[>=]]> #{datefrom}
    	</if>
    	<if test="dateto != null and dateto != ''">
    		and a.createtime <![CDATA[<=]]> #{dateto}
    	</if>
    	<if test="userid != null and userid != ''">
    		and a.createuser = #{userid}
    	</if>
    </where>
     ORDER BY a.createtime DESC LIMIT #{page},#{rows}
  </select>
  
  <select id="findTaskBypageAndrole" resultType="com.zhenapp.po.Custom.TTaskInfoCustom" parameterType="java.util.HashMap" >
    SELECT a.*,b.dicinfoname,c.finishflowcount,c.finishcollectioncount,c.finishshoppingcount,d.errorcount,e.dicinfoname as tasktypename FROM t_task_info a
	LEFT JOIN (select dicinfoid,dicinfoname from t_data_dic_info WHERE dictypecode='runstate') b ON a.taskstate=b.dicinfoid
	left join t_data_dic_info e ON a.tasktype=e.dicinfoid
	LEFT JOIN (SELECT taskid,COUNT(isflow) AS finishflowcount,COUNT(iscreativetitle) AS finishcollectioncount,COUNT(isshopcollect) AS finishshoppingcount FROM t_task_detailinfo where taskstate='21' GROUP BY taskid) c ON a.taskid=c.taskid
	LEFT JOIN (SELECT taskid,COUNT(isflow) AS errorcount FROM t_task_detailinfo WHERE taskstate='22' GROUP BY taskid) d ON a.taskid=d.taskid
	INNER JOIN (SELECT a.* FROM t_user_info a WHERE a.agentid IN (SELECT agentid FROM t_agent_info WHERE agentuserid=#{userid})) f ON a.createuser=f.userid
	<where>
    	<if test="taskid !=null and taskid!=''">
    		and a.taskid like '%${taskid}%'
    	</if>
    	<if test="datefrom != null and datefrom != ''">
    		and a.createtime <![CDATA[>=]]> #{datefrom}
    	</if>
    	<if test="dateto != null and dateto != ''">
    		and a.createtime <![CDATA[<=]]> #{dateto}
    	</if>
    </where>
     ORDER BY a.createtime DESC LIMIT #{page},#{rows}
  </select>
  
    <select id="findTotalTaskBypageAndrole" resultType="int" parameterType="java.util.HashMap" >
    SELECT count(1) FROM t_task_info a
	LEFT JOIN (select dicinfoid,dicinfoname from t_data_dic_info WHERE dictypecode='runstate') b ON a.taskstate=b.dicinfoid
	left join t_data_dic_info e ON a.tasktype=e.dicinfoid
	LEFT JOIN (SELECT taskid,COUNT(isflow) AS finishflowcount,COUNT(iscreativetitle) AS finishcollectioncount,COUNT(isshopcollect) AS finishshoppingcount FROM t_task_detailinfo where taskstate='21' GROUP BY taskid) c ON a.taskid=c.taskid
	LEFT JOIN (SELECT taskid,COUNT(isflow) AS errorcount FROM t_task_detailinfo WHERE taskstate='22' GROUP BY taskid) d ON a.taskid=d.taskid
	INNER JOIN (SELECT a.* FROM t_user_info a WHERE a.agentid IN (SELECT agentid FROM t_agent_info WHERE agentuserid=#{userid})) f ON a.createuser=f.userid
	<where>
    	<if test="taskid !=null and taskid!=''">
    		and a.taskid like '%${taskid}%'
    	</if>
    	<if test="datefrom != null and datefrom != ''">
    		and a.createtime <![CDATA[>=]]> #{datefrom}
    	</if>
    	<if test="dateto != null and dateto != ''">
    		and a.createtime <![CDATA[<=]]> #{dateto}
    	</if>
    </where>
  </select>
  
  <select id="findTotalTaskBypage" resultType="int" parameterType="java.util.HashMap" >
    select count(1) from t_task_info
    <where>
    	<if test="taskid !=null and taskid!=''">
    		and taskid like '%${taskid}%'
    	</if>
    	<if test="datefrom != null and datefrom != ''">
    		and createtime <![CDATA[>=]]> #{datefrom}
    	</if>
    	<if test="dateto != null and dateto != ''">
    		and createtime <![CDATA[<=]]> #{dateto}
    	</if>
    	<if test="userid != null and userid != ''">
    		and createuser = #{userid}
    	</if>
    </where>
  </select>
  
  <select id="findAllTaskBypage" resultType="com.zhenapp.po.Custom.TTaskInfoCustom" parameterType="java.util.HashMap" >
    select * from t_task_info
    <where>
    	<if test="taskid !=null and taskid!=''">
    		and taskid like '%${taskid}%'
    	</if>
    	<if test="datefrom != null and datefrom != ''">
    		and createtime <![CDATA[>=]]> #{datefrom}
    	</if>
    	<if test="dateto != null and dateto != ''">
    		and createtime <![CDATA[<=]]> #{dateto}
    	</if>
    </where>
  </select>
  
  <select id="findTaskallocation" resultType="com.zhenapp.po.Custom.TTaskInfoCustom" parameterType="java.util.HashMap" >
    select * from t_task_info
    <where>
    	<if test="taskstate !=null and taskstate !=''">
    		AND taskstate=#{taskstate} 
    	</if>
    	<if test="taskdate != null and taskdate != ''">
    		AND taskdate = #{taskdate} 
    	</if>
    </where>
  </select>
  
  <select id="findTaskInfoByTaskid" resultType="com.zhenapp.po.Custom.TTaskInfoCustom" parameterType="String" >
    select * from t_task_info WHERE taskid=#{taskid}
  </select>
  
  <select id="findIsFirst" resultType="com.zhenapp.po.Custom.TTaskInfoCustom" parameterType="String" >
    select * from t_task_info WHERE taskkeynum=#{taskkeynum}
  </select>
  
  
  <insert id="insertTaskInfo" parameterType="com.zhenapp.po.Custom.TTaskInfoCustom" >
      insert into t_task_info ( taskid, tasktype, 
      taskkeynum, taskstartdate, taskenddate, 
      taskdate, taskreleasekeyword, taskkeyword, 
      taskhourcounts, taskminprice, taskmaxprice, 
      tasksearchType, taskimgztc, taskimgpt, 
      flowcount, Collectioncount, Shoppingcount, 
      tasktmallapppct, taskgprspct, taskPlus, 
      taskduration, subtractpoints, taskstate, 
      createtime, createuser, updatetime, 
      updateuser)
    values ( #{taskid,jdbcType=VARCHAR}, #{tasktype,jdbcType=VARCHAR}, 
      #{taskkeynum,jdbcType=VARCHAR}, #{taskstartdate,jdbcType=VARCHAR}, #{taskenddate,jdbcType=VARCHAR}, 
      #{taskdate,jdbcType=VARCHAR}, #{taskreleasekeyword,jdbcType=VARCHAR}, #{taskkeyword,jdbcType=VARCHAR}, 
      #{taskhourcounts,jdbcType=VARCHAR}, #{taskminprice,jdbcType=VARCHAR}, #{taskmaxprice,jdbcType=VARCHAR}, 
      #{tasksearchtype,jdbcType=VARCHAR}, #{taskimgztc,jdbcType=VARCHAR}, #{taskimgpt,jdbcType=VARCHAR}, 
      #{flowcount,jdbcType=INTEGER}, #{collectioncount,jdbcType=INTEGER}, #{shoppingcount,jdbcType=INTEGER}, 
      #{tasktmallapppct,jdbcType=VARCHAR}, #{taskgprspct,jdbcType=VARCHAR}, #{taskplus,jdbcType=VARCHAR}, 
      #{taskduration,jdbcType=VARCHAR}, #{subtractpoints,jdbcType=INTEGER}, #{taskstate,jdbcType=VARCHAR}, 
      #{createtime,jdbcType=VARCHAR}, #{createuser,jdbcType=VARCHAR}, #{updatetime,jdbcType=VARCHAR}, 
      #{updateuser,jdbcType=VARCHAR})
  </insert>
  
  <update id="updateTaskstate" parameterType="java.util.HashMap">
  	update t_task_info set taskstate=#{taskstate} where taskid=#{taskid} and createuser=#{userid}
  </update>
  
  <delete id="deleteTaskBypk" parameterType="String">
    delete from t_task_info where taskpk in (${value})
  </delete>
</mapper>
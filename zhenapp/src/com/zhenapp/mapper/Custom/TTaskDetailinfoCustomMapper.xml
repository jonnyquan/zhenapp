<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.zhenapp.mapper.Custom.TTaskDetailinfoCustomMapper" >
  <select id="requesttaskByphoneid" parameterType="String" resultType="com.zhenapp.po.Custom.TTaskDetailInfoCustom">
  	SELECT * FROM t_task_detailinfo WHERE taskkeynum NOT IN (
SELECT taskkeynum FROM t_task_detailinfo WHERE taskdate=DATE_FORMAT(NOW(),'%Y%m%d') AND phoneid = #{phoneid}
) and phoneid is null and taskstate = '40' ORDER BY taskhour,taskminute LIMIT 0,1
  </select>
  
  <select id="findTaskDetailByPage" resultType="com.zhenapp.po.Custom.TTaskDetailInfoCustom" parameterType="java.util.HashMap">
	 SELECT a.taskdetailpk, a.taskdetailid, a.taskid, a.taskkeyword, a.searchtype, a.price, a.region, a.isfreeship, 
    a.istmall, a.iscollection,CASE WHEN a.iscollection='0' THEN '否' ELSE '是' END AS iscollectionname,a.isshopping, CASE WHEN a.isshopping='0' THEN '否' ELSE '是' END AS isshoppingname, a.taskkeynum, a.minpicture, a.maxpicture, a.tasktype, 
    a.isflow, a.iscreativetitle, a.isshopcollect, a.taskstate, a.taskdate, a.taskhour, a.taskminute, 
    a.visit,b.dictypename AS visitname ,a.collect,c.dictypename AS collectname, a.trolley, d.dictypename AS trolleyname, a.phoneid, a.subtractpoints, a.resultstr,a.createtime, a.createuser, a.updatetime, 
    a.updateuser FROM t_task_detailinfo a
	LEFT JOIN t_data_dic_info b ON a.visit=b.dicinfoid
	LEFT JOIN t_data_dic_info c ON a.collect=c.dicinfoid
	LEFT JOIN t_data_dic_info d ON a.trolley=d.dicinfoid
	  <where>
	  	<if test="taskid !=null and taskid != ''">
	  		a.taskid = #{taskid}
	  	</if>
	  	<if test="taskkeynum !=null and taskkeynum != ''">
	  		a.taskkeynum = #{taskkeynum}
	  	</if>
	  	<if test="phoneid !=null and phoneid != ''">
	  		a.phoneid = #{phoneid}
	  	</if>
	  	<if test="taskhour !=null and taskhour != ''">
	  		a.taskhour = #{taskhour}
	  	</if>
	  	<if test="tasktype !=null and tasktype != ''">
	  		a.tasktype = #{tasktype}
	  	</if>
	  </where>
	  order by a.phoneid desc limit #{page},#{rows}
  </select>
    <select id="findTaskDetailTotalByPage" resultType="int" parameterType="java.util.HashMap">
	  SELECT count(1) FROM t_task_detailinfo a
	  <where>
	  	<if test="taskid !=null and taskid != ''">
	  		a.taskid = #{taskid}
	  	</if>
	  	<if test="taskkeynum !=null and taskkeynum != ''">
	  		a.taskkeynum = #{taskkeynum}
	  	</if>
	  	<if test="phoneid !=null and phoneid != ''">
	  		a.phoneid = #{phoneid}
	  	</if>
	  	<if test="taskhour !=null and taskhour != ''">
	  		a.taskhour = #{taskhour}
	  	</if>
	  	<if test="tasktype !=null and tasktype != ''">
	  		a.tasktype = #{tasktype}
	  	</if>
	  </where>
  </select>
  
  
  <insert id="insertDetailinfo" parameterType="com.zhenapp.po.Custom.TTaskDetailInfoCustom" >
     insert into t_task_detailinfo (taskdetailid, taskid, 
      taskkeyword, searchtype, price, 
      region, isfreeship, istmall, 
      iscollection, isshopping, taskkeynum, 
      minpicture, maxpicture, tasktype, 
      isflow, iscreativetitle, isshopcollect, 
      taskstate, taskdate, taskhour, 
      taskminute, visit, collect, 
      trolley, phoneid, subtractpoints, 
      createtime, createuser, updatetime, 
      updateuser)
    values ( #{taskdetailid,jdbcType=VARCHAR}, #{taskid,jdbcType=VARCHAR}, 
      #{taskkeyword,jdbcType=VARCHAR}, #{searchtype,jdbcType=VARCHAR}, #{price,jdbcType=VARCHAR}, 
      #{region,jdbcType=VARCHAR}, #{isfreeship,jdbcType=VARCHAR}, #{istmall,jdbcType=VARCHAR}, 
      #{iscollection,jdbcType=VARCHAR}, #{isshopping,jdbcType=VARCHAR}, #{taskkeynum,jdbcType=VARCHAR}, 
      #{minpicture,jdbcType=VARCHAR}, #{maxpicture,jdbcType=VARCHAR}, #{tasktype,jdbcType=VARCHAR}, 
      #{isflow,jdbcType=VARCHAR}, #{iscreativetitle,jdbcType=VARCHAR}, #{isshopcollect,jdbcType=VARCHAR}, 
      #{taskstate,jdbcType=VARCHAR}, #{taskdate,jdbcType=VARCHAR}, #{taskhour,jdbcType=VARCHAR}, 
      #{taskminute,jdbcType=VARCHAR}, #{visit,jdbcType=VARCHAR}, #{collect,jdbcType=VARCHAR}, 
      #{trolley,jdbcType=VARCHAR}, #{phoneid,jdbcType=VARCHAR}, #{subtractpoints,jdbcType=INTEGER}, 
      #{createtime,jdbcType=VARCHAR}, #{createuser,jdbcType=VARCHAR}, #{updatetime,jdbcType=VARCHAR}, 
      #{updateuser,jdbcType=VARCHAR})
  </insert>

  <update id="updateTaskDetailstate" parameterType="java.util.HashMap">
  	update t_task_detailinfo set taskstate = #{taskstate},phoneid = #{phoneid}  where taskdetailid = #{taskdetailid} and phoneid is null
  </update>
  
  <update id="updateTaskDetailresultByid"  parameterType="java.util.HashMap" >
  	update t_task_detailinfo set resultstr=#{result},updatetime=#{updatetime},updateuser=#{updateuser} where taskdetailid = #{taskdetailid} and phoneid is not null
  </update>
  
  <update id="updateTaskDetailstateByTaskidAndoldstate" parameterType="java.util.HashMap">
  	update t_task_detailinfo set taskstate = #{newstate},updatetime=#{updatetime},updateuser=#{updateuser} where taskid = #{taskid}  and taskstate in (${oldstate})
  </update>
  
  <update id="updateterminationstate" parameterType="java.util.HashMap">
  	update t_task_detailinfo set taskstate = '23'  where taskid = #{taskid} and phoneid is null and taskstate = '40'
  </update>
  
  <select id="findPointsByteterminationstate" parameterType="String" resultType="int">
  	select IFNULL(sum(subtractpoints),0) from t_task_detailinfo where taskid = #{taskid} and taskstate = '23'
  </select>
  <select id="findTaskDetailByPidAndState" parameterType="java.util.HashMap" resultType="com.zhenapp.po.Custom.TTaskDetailInfoCustom">
  	select * from t_task_detailinfo where phoneid = #{phoneid} and taskstate = #{taskstate}
  </select>
  
  <update id="updateTaskDetailByPidAndState" parameterType="java.util.HashMap" >
  	UPDATE t_task_detailinfo SET visit = (SELECT dicinfoid FROM t_data_dic_info WHERE dictypecode = 'visit' AND dictypename=#{visit}),
  	collect = (SELECT dicinfoid FROM t_data_dic_info WHERE dictypecode = 'collect' AND dictypename=#{collect}),
  	trolley = (SELECT dicinfoid FROM t_data_dic_info WHERE dictypecode = 'trolley' AND dictypename=#{trolley}),
  	taskstate = #{taskstatenew},
  	updatetime=#{updatetime},updateuser=#{updateuser}
	WHERE phoneid =#{phoneid} AND taskstate=#{taskstate}
  </update>
</mapper>